name: Scrape
on:
  schedule:
    - cron: "*/8 * * * *"
  workflow_dispatch:
jobs:
  scrape:
    name: "Scrape latest photo"
    runs-on: ubuntu-latest
    steps:
      - name: "(setup) checkout"
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: "(setup) deno"
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      - 
        name: "(setup) git"
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - id: scrape
        name: "(run) deno task scrape"
        env:
          DENO_KV_PATH: ${{ secrets.DENO_KV_PATH }}
          DENO_KV_ACCESS_TOKEN: ${{ secrets.DENO_KV_ACCESS_TOKEN }}
        run: deno task scrape

      - if: ${{ steps.scrape.outputs.filename == '' }}
        name: "no new photo captured"
        run: |
          echo -e $'\e[1;7;31mERROR\e[0m \e[1;3;91mNo new photo captured!\e[0m'
          exit 1
        
      - if: ${{ success() }}
        name: "(run) upload artifacts"
        uses: actions/upload-artifact@v3
        with:
          path: ${{ steps.scrape.outputs.filename }}
        
      - name: "(git) commit + push"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add .
          git commit -m "[$(date +"%F %H:%M:%S %Z")]: new photo captured"
          git push
